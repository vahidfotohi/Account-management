name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ù†ØµØ¨ Ù¾Ø§Ø¯Ù‡Ø§ (Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù…: Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Pods Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯)
      - name: Install Pods
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # Ù…Ø±Ø­Ù„Ù‡ Û²: Ø¬Ø±Ø§Ø­ÛŒ Ú©Ø§Ù…Ù„ (Runner + Pods) Ø¨Ø§ Ø±ÙˆØ¨ÛŒ
      - name: Disable Code Signing completely (Runner & Pods)
        run: |
          cd ios
          ruby -e '
            require "xcodeproj"

            # ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ø¯Ø± ÛŒÚ© Ù¾Ø±ÙˆÚ˜Ù‡
            def disable_signing(project_path)
              return unless File.exist?(project_path)
              puts "Processing: #{project_path}"
              project = Xcodeproj::Project.open(project_path)
          
              project.targets.each do |target|
                puts "  Target: #{target.name}"
                target.build_configurations.each do |config|
                  config.build_settings["CODE_SIGN_STYLE"] = "Manual"
                  config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"
                  config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"
                  config.build_settings["CODE_SIGN_IDENTITY"] = ""
                  config.build_settings["EXPANDED_CODE_SIGN_IDENTITY"] = ""
                  config.build_settings["PROVISIONING_PROFILE_SPECIFIER"] = ""
                  config.build_settings["DEVELOPMENT_TEAM"] = ""
                end
              end
          
              # ÙÙ‚Ø· Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ØµÙ„ÛŒ Ø§ÛŒÙ† Ø§ØªØ±ÛŒØ¨ÛŒÙˆØªâ€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯
              if project.root_object.attributes["TargetAttributes"]
                 project.root_object.attributes.delete("TargetAttributes")
              end
          
              project.save
            end

            # 1. Ø§ØµÙ„Ø§Ø­ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ØµÙ„ÛŒ
            disable_signing("Runner.xcodeproj")
          
            # 2. Ø§ØµÙ„Ø§Ø­ Ù¾Ø±ÙˆÚ˜Ù‡ Ù¾Ø§Ø¯Ù‡Ø§ (Ø§ØºÙ„Ø¨ Ø§Ø±ÙˆØ± Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ù†Ø§Ø´ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            disable_signing("Pods/Pods.xcodeproj")
          '
          
          # Ù„Ø§ÛŒÙ‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†: ØªØ²Ø±ÛŒÙ‚ Ø¨Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ ÙÙ„Ø§ØªØ±
          echo "CODE_SIGNING_REQUIRED=NO" >> Flutter/Release.xcconfig
          echo "CODE_SIGNING_ALLOWED=NO" >> Flutter/Release.xcconfig
          echo "CODE_SIGN_IDENTITY=" >> Flutter/Release.xcconfig
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> Flutter/Release.xcconfig
          
          cd ..

      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¨ÛŒÙ„Ø¯ ØªÙ…ÛŒØ² (Ø¨Ø¯ÙˆÙ† Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ø§Ø±ÙˆØ± Ù…ÛŒâ€ŒØ´Ø¯Ù†Ø¯)
      - run: flutter build ios --release --no-codesign

      # Ù…Ø±Ø­Ù„Ù‡ Û´: Ù¾Ú©ÛŒØ¬ Ú©Ø±Ø¯Ù†
      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "Signed-disabled release"