name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ù†ØµØ¨ Ù¾Ø§Ø¯Ù‡Ø§
      - name: Install Pods
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # Ù…Ø±Ø­Ù„Ù‡ Û²: Ø­Ù…Ù„Ù‡ Ø³Ù‡â€ŒØ¬Ø§Ù†Ø¨Ù‡ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø§ÛŒÙ†ÛŒÙ†Ú¯
      - name: Force Disable Signing (Project + Configs)
        run: |
          cd ios
          
          # Ø§Ù„Ù) Ù„Ø§ÛŒÙ‡ Ø§ÙˆÙ„: Ø§ØµÙ„Ø§Ø­ ÙØ§ÛŒÙ„ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ Ruby
          ruby -e '
            require "xcodeproj"
            project_path = "Runner.xcodeproj"
            project = Xcodeproj::Project.open(project_path)
          
            project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings["CODE_SIGN_STYLE"] = "Manual"
                config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"
                config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"
                config.build_settings["CODE_SIGN_IDENTITY"] = ""
                config.build_settings["EXPANDED_CODE_SIGN_IDENTITY"] = ""
                config.build_settings["PROVISIONING_PROFILE_SPECIFIER"] = ""
                config.build_settings["DEVELOPMENT_TEAM"] = ""
              end
            end
          
            # Ø­Ø°Ù Ø§ØªØ±ÛŒØ¨ÛŒÙˆØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø²Ø§Ø­Ù…
            project.root_object.attributes.delete("TargetAttributes")
            project.save
          '
          
          # Ø¨) Ù„Ø§ÛŒÙ‡ Ø¯ÙˆÙ…: ØªØ²Ø±ÛŒÙ‚ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ XCConfig ÙÙ„Ø§ØªØ±
          # Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ØŒ Ù¾Ø³ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù… ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒÙ…
          echo "CODE_SIGNING_REQUIRED=NO" >> Flutter/Release.xcconfig
          echo "CODE_SIGNING_ALLOWED=NO" >> Flutter/Release.xcconfig
          echo "CODE_SIGN_IDENTITY=" >> Flutter/Release.xcconfig
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> Flutter/Release.xcconfig
          
          # Ù…Ø­Ø¶ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¨Ø±Ø§ÛŒ Debug Ùˆ Generated Ù‡Ù… Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒØ¯Ù‡ÛŒÙ…
          echo "CODE_SIGNING_REQUIRED=NO" >> Flutter/Debug.xcconfig
          echo "CODE_SIGNING_ALLOWED=NO" >> Flutter/Debug.xcconfig
          
          cd ..

      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¨ÛŒÙ„Ø¯ Ø¨Ø§ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø²ÙˆØ±Ú©ÛŒ (Ù„Ø§ÛŒÙ‡ Ø³ÙˆÙ…)
      # Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…: Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² -- Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ xcodebuild Ù…ÛŒâ€ŒØ±ÙˆÙ†Ø¯
      - name: Build iOS without Signing
        run: >
          flutter build ios --release --no-codesign --
          CODE_SIGNING_REQUIRED=NO 
          CODE_SIGNING_ALLOWED=NO 
          CODE_SIGN_IDENTITY="" 
          EXPANDED_CODE_SIGN_IDENTITY=""

      # Ù…Ø±Ø­Ù„Ù‡ Û´: Ø³Ø§Ø®Øª Payload
      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "Release generated with Triple-Layer Force Fix"