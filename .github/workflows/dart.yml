name: iOS-Device-Build

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - run: flutter pub get

      - name: ğŸ› ï¸ Final Hard Fix for Device
        run: |
          cd ios
          pod install --repo-update
          # Ø­Ø°Ù Ù…Ø³ØªÙ‚ÛŒÙ… ØªÙ…Ø§Ù… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ø¶Ø§ Ø§Ø² ÙØ§ÛŒÙ„ Ù¾Ø±ÙˆÚ˜Ù‡ Ø´Ù…Ø§ 
          sed -i '' '/DEVELOPMENT_TEAM/d' Runner.xcodeproj/project.pbxproj
          sed -i '' '/ProvisioningStyle/d' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' Runner.xcodeproj/project.pbxproj
          cd ..

      - name: ğŸš€ Build for Real Device
        run: |
          # Ø¨ÛŒÙ„Ø¯ Ø¨Ø¯ÙˆÙ† Ø§Ù…Ø¶Ø§ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ´ÛŒ (iphoneos)
          flutter build ios --release --no-codesign

      - name: ğŸ“¦ Create IPA
        run: |
          # Ø­Ø§Ù„Ø§ Ù¾ÙˆØ´Ù‡ iphoneos ÙˆØ¬ÙˆØ¯ Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -qq -r ConstructionManager.ipa Payload/

      - name: ğŸ“¤ Upload Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/ConstructionManager.ipa
          tag: v1.0-device
          overwrite: true