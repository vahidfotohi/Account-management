name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      # Û±. Ù†ØµØ¨ Ù¾Ø§Ø¯Ù‡Ø§ (Ø§ÛŒÙ†Ø¬Ø§ ÙØ§ÛŒÙ„ Ù¾Ø±ÙˆÚ˜Ù‡ Ø®Ø§Ù… ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
      - name: Install Pods
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # Û². Ø¬Ø±Ø§Ø­ÛŒ Ø¯Ù‚ÛŒÙ‚ ÙØ§ÛŒÙ„ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ Ø±ÙˆØ¨ÛŒ (Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ù…Ø´Ú©Ù„ RunnerTests)
      - name: Disable Code Signing via Ruby
        run: |
          cd ios
          ruby -e '
            require "xcodeproj"
            project_path = "Runner.xcodeproj"
            project = Xcodeproj::Project.open(project_path)
          
            # Ú†Ø±Ø®ÛŒØ¯Ù† Ø±ÙˆÛŒ ØªÙ…Ø§Ù… ØªØ§Ø±Ú¯Øªâ€ŒÙ‡Ø§ (Ù‡Ù… Runner Ùˆ Ù‡Ù… RunnerTests)
            project.targets.each do |target|
              target.build_configurations.each do |config|
                # Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¯Ø³ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†Ú© Ú©Ø±Ø¯Ù† Ø§Ú©Ø§Ù†Øª Ø§Ù¾Ù„
                config.build_settings["CODE_SIGN_STYLE"] = "Manual"
          
                # ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ù„Ø²Ø§Ù…Ø§Øª Ø§Ù…Ø¶Ø§
                config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"
                config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"
                config.build_settings["CODE_SIGN_IDENTITY"] = ""
                config.build_settings["EXPANDED_CODE_SIGN_IDENTITY"] = ""
                config.build_settings["PROVISIONING_PROFILE_SPECIFIER"] = ""
                config.build_settings["DEVELOPMENT_TEAM"] = ""
              end
            end
          
            # Ø­Ø°Ù Ø§ØªØ±ÛŒØ¨ÛŒÙˆØªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªÛŒÙ… Ø¢ÛŒâ€ŒØ¯ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±Ù†Ø¯
            project.root_object.attributes.delete("TargetAttributes")
          
            project.save
          '
          cd ..

      # Û³. Ø¨ÛŒÙ„Ø¯ Ù†Ù‡Ø§ÛŒÛŒ
      - run: flutter build ios --release --no-codesign

      # Û´. Ù¾Ú©ÛŒØ¬ Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ÛŒ
      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "Release generated via Ruby fix"