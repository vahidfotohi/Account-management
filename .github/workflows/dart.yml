name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - run: flutter pub get

      # Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§ÙˆÙ„ Ù¾Ø§Ø¯Ù‡Ø§ Ø±Ø§ Ù†ØµØ¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ ÙØ§ÛŒÙ„ Ù¾Ø±ÙˆÚ˜Ù‡ Ú©Ø§Ù…Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯
      - name: Install Pods
        run: |
          cd ios
          pod install --repo-update
          cd ..

      # Ù…Ø±Ø­Ù„Ù‡ Û²: Ø­Ø§Ù„Ø§ Ú©Ù‡ ÙØ§ÛŒÙ„ Ù¾Ø±ÙˆÚ˜Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ø¯ØŒ Ø§Ù…Ø¶Ø§ Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
      - name: Disable Code Signing and Identities
        run: |
          cd ios
          
          # 1. ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª Ø³Ø§ÛŒÙ†ÛŒÙ†Ú¯ Ø§Ø² Automatic Ø¨Ù‡ Manual
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' Runner.xcodeproj/project.pbxproj
          
          # 2. Ø­Ø°Ù Development Team
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          
          # 3. ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø³Ø§ÛŒÙ† Ø´Ø¯Ù†
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' Runner.xcodeproj/project.pbxproj
          
          # 4. Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ù‡ÙˆÛŒØª Ø³Ø§ÛŒÙ†ÛŒÙ†Ú¯ (Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø§Ø±ÙˆØ± Ø´Ù…Ø§)
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer";/CODE_SIGN_IDENTITY = "";/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' Runner.xcodeproj/project.pbxproj

      # Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¨ÛŒÙ„Ø¯ Ú¯Ø±ÙØªÙ† (Ø¯ÛŒÚ¯Ø± Ø®ÙˆØ¯Ø´ pod install Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú†ÙˆÙ† Ù‚Ø¨Ù„Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡)
      - run: flutter build ios --release --no-codesign

      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is first release"